# .github/workflows/generate-dt-from-rom-url.yml
name: Generate Device Tree from ROM URL

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Direct download URL of the stock ROM ZIP file'
        required: true
      output_name:
        description: 'Custom name for the output device tree folder (optional)'
        required: false
        default: ''
      skip_proprietary:
        description: 'Skip generating proprietary-files.txt and extract-files.sh?'
        required: false
        default: false
        type: boolean

jobs:
  generate:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04  # Use a full Ubuntu container for maximum compatibility

    steps:
      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            python3 python3-pip python3-venv \
            curl wget unzip p7zip-full lz4 xz-utils \
            && rm -rf /var/lib/apt/lists/*
        shell: bash

      - name: Set up Python virtual environment
        run: |
          python3 -m venv /opt/venv
          echo "/opt/venv/bin" >> $GITHUB_PATH
        shell: bash

      - name: Install dumpyara and aospdtgen
        run: |
          pip install --upgrade pip
          pip install dumpyara aospdtgen
        shell: bash

      - name: Download ROM ZIP
        run: |
          echo "Downloading ROM from ${{ github.event.inputs.rom_url }} ..."
          curl -L -o rom.zip "${{ github.event.inputs.rom_url }}"
          if [ ! -f rom.zip ]; then
            echo "Download failed!"
            exit 1
          fi
          echo "Download complete. File size: $(du -h rom.zip | cut -f1)"
        shell: bash

      - name: Extract partitions with dumpyara
        id: extract
        run: |
          mkdir -p dump_output
          echo "Running dumpyara on rom.zip ..."
          python -m dumpyara rom.zip -o dump_output
          if [ ! -d dump_output/system ]; then
            echo "dumpyara failed to extract system partition!"
            exit 1
          fi
          echo "dump_path=dump_output" >> $GITHUB_OUTPUT
        shell: bash

      - name: Generate device tree with aospdtgen
        id: generate
        run: |
          # Determine output directory name
          if [ -z "${{ github.event.inputs.output_name }}" ]; then
            OUTPUT_DIR="device_tree_$(date +'%Y%m%d_%H%M%S')"
          else
            OUTPUT_DIR="${{ github.event.inputs.output_name }}"
          fi

          CMD="python -m aospdtgen --output $OUTPUT_DIR"
          if [ "${{ github.event.inputs.skip_proprietary }}" == "true" ]; then
            CMD="$CMD --no-proprietary-files"
          fi
          CMD="$CMD ${{ steps.extract.outputs.dump_path }}"

          echo "Running: $CMD"
          eval $CMD

          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "aospdtgen failed to produce output directory!"
            exit 1
          fi

          echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create artifact archive
        run: |
          tar -czf device_tree.tar.gz -C ${{ steps.generate.outputs.output_dir }} .
        shell: bash

      - name: Upload device tree artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.generate.outputs.output_dir }}
          path: device_tree.tar.gz
          retention-days: 7

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f rom.zip
          rm -rf dump_output ${{ steps.generate.outputs.output_dir }} device_tree.tar.gz
        shell: bash
