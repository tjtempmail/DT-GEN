name: ü§ñ Device Tree Generator Pro
run-name: Generate Device Tree from ${{ inputs.rom_url }}

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'üì¶ Direct URL to Stock ROM ZIP (OTA/Full ROM)'
        required: true
        type: string
      rom_type:
        description: 'üì± ROM Type'
        required: true
        type: choice
        options:
          - 'auto'
          - 'ota'
          - 'fastboot'
          - 'kdz'
          - 'tar_md5'
        default: 'auto'
      device_codename:
        description: 'üè∑Ô∏è Device Codename (optional, auto-detected if empty)'
        required: false
        type: string
      manufacturer:
        description: 'üè≠ Manufacturer (optional, auto-detected if empty)'
        required: false
        type: string
      generate_twrp:
        description: 'üîÑ Also Generate TWRP Device Tree'
        required: false
        type: boolean
        default: false
      upload_artifacts:
        description: '‚òÅÔ∏è Upload Artifacts to Release'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'
  WORKSPACE: ${{ github.workspace }}
  OUTPUT_DIR: ${{ github.workspace }}/output

jobs:
  extract-and-generate:
    name: üîß Extract Firmware & Generate Device Tree
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üêç Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Install System Dependencies
        run: |
          echo "::group::Installing system packages..."
          sudo apt-get update -qq
          
          # Install packages with error handling
          sudo apt-get install -y -qq \
            unace unrar zip unzip p7zip-full p7zip-rar \
            sharutils rar uudeview mpack arj cabextract \
            rename liblzma-dev brotli lz4 \
            protobuf-compiler git gawk cpio \
            erofs-utils android-sdk-libsparse-utils \
            libxml2-utils bc curl wget \
            python3-dev build-essential file device-tree-compiler \
            || echo "Some packages failed, continuing..."
          
          # img2simg is part of android-sdk-libsparse-utils as simg2img
          which simg2img || echo "simg2img not found"
          echo "::endgroup::"

      - name: üì¶ Install Python Tools
        run: |
          echo "::group::Installing Python packages..."
          pip install --upgrade pip setuptools wheel
          
          # Install dumpyara from git
          pip install git+https://github.com/sebastianmuetzel/dumpyara.git
          
          # Install aospdtgen
          pip install aospdtgen
          
          # Install twrpdtgen if needed
          if [[ "${{ inputs.generate_twrp }}" == "true" ]]; then
            pip install twrpdtgen
          fi
          
          # Install dependencies
          pip install \
            extract-dtb \
            pycryptodome \
            protobuf \
            backports.lzma \
            requests \
            tqdm \
            colorama \
            lz4 \
            zstandard \
            pyyaml \
            lxml
          echo "::endgroup::"

      - name: ‚¨áÔ∏è Download Firmware
        id: download
        run: |
          echo "::group::Downloading firmware..."
          mkdir -p ${{ env.OUTPUT_DIR }}
          DOWNLOAD_DIR="${{ env.WORKSPACE }}/downloads"
          mkdir -p "$DOWNLOAD_DIR"
          
          FILENAME=$(basename "${{ inputs.rom_url }}" | cut -d'?' -f1 | cut -d'#' -f1)
          [[ -z "$FILENAME" ]] && FILENAME="firmware.zip"
          
          echo "üì• Downloading: $FILENAME"
          
          # Download with curl
          curl -L -o "$DOWNLOAD_DIR/$FILENAME" --progress-bar "${{ inputs.rom_url }}"
          
          if [[ ! -f "$DOWNLOAD_DIR/$FILENAME" ]]; then
            echo "‚ùå Download failed!"
            exit 1
          fi
          
          echo "‚úÖ Downloaded: $(du -h $DOWNLOAD_DIR/$FILENAME | cut -f1)"
          echo "firmware_path=$DOWNLOAD_DIR/$FILENAME" >> $GITHUB_OUTPUT
          echo "firmware_name=$FILENAME" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üóÇÔ∏è Extract Firmware with Dumpyara
        id: dumpyara
        run: |
          echo "::group::Extracting firmware..."
          FIRMWARE_PATH="${{ steps.download.outputs.firmware_path }}"
          DUMP_DIR="${{ env.OUTPUT_DIR }}/dump"
          mkdir -p "$DUMP_DIR"
          
          echo "üöÄ Running dumpyara..."
          dumpyara "$FIRMWARE_PATH" "$DUMP_DIR" 2>&1 | tee "${{ env.OUTPUT_DIR }}/dumpyara.log"
          
          # Find extracted directory
          EXTRACTED_DIR=$(find "$DUMP_DIR" -maxdepth 3 -type d -name "system" | head -1 | xargs dirname 2>/dev/null || \
                          find "$DUMP_DIR" -maxdepth 3 -type d -name "vendor" | head -1 | xargs dirname 2>/dev/null || \
                          echo "$DUMP_DIR")
          
          if [[ ! -d "$EXTRACTED_DIR" ]]; then
            echo "‚ùå Extraction failed!"
            ls -laR "$DUMP_DIR"
            exit 1
          fi
          
          echo "üìÅ Extracted to: $EXTRACTED_DIR"
          ls -la "$EXTRACTED_DIR"
          
          echo "extracted_path=$EXTRACTED_DIR" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üå≥ Generate AOSP Device Tree
        id: aospdtgen
        run: |
          echo "::group::Generating AOSP device tree..."
          EXTRACTED_PATH="${{ steps.dumpyara.outputs.extracted_path }}"
          DT_DIR="${{ env.OUTPUT_DIR }}/device-tree-aosp"
          mkdir -p "$DT_DIR"
          
          echo "üå≤ Running aospdtgen..."
          aospdtgen -o "$DT_DIR" "$EXTRACTED_PATH" 2>&1 | tee "${{ env.OUTPUT_DIR }}/aospdtgen.log"
          
          FILE_COUNT=$(find "$DT_DIR" -type f 2>/dev/null | wc -l)
          echo "‚úÖ Generated $FILE_COUNT files"
          
          echo "aosp_dt_path=$DT_DIR" >> $GITHUB_OUTPUT
          echo "aosp_file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üîÑ Generate TWRP Device Tree (Optional)
        if: inputs.generate_twrp == true
        id: twrpdtgen
        run: |
          echo "::group::Generating TWRP device tree..."
          EXTRACTED_PATH="${{ steps.dumpyara.outputs.extracted_path }}"
          TWRP_DIR="${{ env.OUTPUT_DIR }}/device-tree-twrp"
          mkdir -p "$TWRP_DIR"
          
          RECOVERY_IMG=$(find "$EXTRACTED_PATH" -maxdepth 3 -name "recovery.img" | head -1)
          BOOT_IMG=$(find "$EXTRACTED_PATH" -maxdepth 3 -name "boot.img" | head -1)
          TARGET_IMG="${RECOVERY_IMG:-$BOOT_IMG}"
          
          if [[ -z "$TARGET_IMG" ]]; then
            echo "‚ö†Ô∏è No recovery/boot image found"
            echo "twrp_status=skipped" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          echo "üîÑ Processing: $TARGET_IMG"
          twrpdtgen -o "$TWRP_DIR" "$TARGET_IMG" 2>&1 | tee "${{ env.OUTPUT_DIR }}/twrpdtgen.log" || true
          
          TWRP_COUNT=$(find "$TWRP_DIR" -type f 2>/dev/null | wc -l)
          echo "twrp_dt_path=$TWRP_DIR" >> $GITHUB_OUTPUT
          echo "twrp_status=completed" >> $GITHUB_OUTPUT
          echo "twrp_file_count=$TWRP_COUNT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: üì¶ Package & Upload
        run: |
          echo "::group::Packaging..."
          cd ${{ env.OUTPUT_DIR }}
          
          # Create archives
          if [[ -d "device-tree-aosp" ]] && [[ "$(ls -A device-tree-aosp 2>/dev/null)" ]]; then
            tar -czf aosp-device-tree.tar.gz device-tree-aosp/
            echo "‚úÖ AOSP DT archived"
          fi
          
          if [[ -d "device-tree-twrp" ]] && [[ "$(ls -A device-tree-twrp 2>/dev/null)" ]]; then
            tar -czf twrp-device-tree.tar.gz device-tree-twrp/
            echo "‚úÖ TWRP DT archived"
          fi
          
          echo "::endgroup::"

      - name: ‚òÅÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: device-tree-${{ github.run_id }}
          path: |
            ${{ env.OUTPUT_DIR }}/*.tar.gz
            ${{ env.OUTPUT_DIR }}/*.log
          retention-days: 30
          if-no-files-found: warn
