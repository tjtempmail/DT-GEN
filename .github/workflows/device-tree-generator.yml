name: ðŸ¤– Device Tree Generator Pro
run-name: Generate Device Tree from ${{ inputs.rom_url }}

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'ðŸ“¦ Direct URL to Stock ROM ZIP (OTA/Full ROM)'
        required: true
        type: string
      rom_type:
        description: 'ðŸ“± ROM Type'
        required: true
        type: choice
        options:
          - 'auto'
          - 'ota'
          - 'fastboot'
          - 'kdz'
          - 'tar_md5'
        default: 'auto'
      device_codename:
        description: 'ðŸ·ï¸ Device Codename (optional, auto-detected if empty)'
        required: false
        type: string
      manufacturer:
        description: 'ðŸ­ Manufacturer (optional, auto-detected if empty)'
        required: false
        type: string
      generate_twrp:
        description: 'ðŸ”„ Also Generate TWRP Device Tree'
        required: false
        type: boolean
        default: false
      upload_artifacts:
        description: 'â˜ï¸ Upload Artifacts to Release'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'
  WORKSPACE: ${{ github.workspace }}
  OUTPUT_DIR: ${{ github.workspace }}/output

jobs:
  extract-and-generate:
    name: ðŸ”§ Extract Firmware & Generate Device Tree
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # Cache disabled - no requirements.txt needed
          cache: 'pip'
          cache-dependency-path: '**/requirements_dummy.txt'

      - name: ðŸ”§ Install System Dependencies
        run: |
          echo "::group::Installing system packages..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            unace unrar zip unzip p7zip-full p7zip-rar \
            sharutils rar uudeview mpack arj cabextract \
            rename liblzma-dev brotli lz4 \
            protobuf-compiler git gawk cpio \
            erofs-utils android-sdk-libsparse-utils \
            libxml2-utils bc curl wget aria2 \
            python3-dev build-essential file device-tree-compiler
          echo "::endgroup::"

      - name: ðŸ“¦ Install Python Tools
        run: |
          echo "::group::Installing Python packages..."
          pip install --upgrade pip setuptools wheel
          
          # Install dumpyara from source for latest fixes
          pip install git+https://github.com/sebastianmuetzel/dumpyara.git || pip install dumpyara
          
          # Install aospdtgen
          pip install aospdtgen
          
          # Install twrpdtgen if needed
          if [[ "${{ inputs.generate_twrp }}" == "true" ]]; then
            pip install twrpdtgen
          fi
          
          # Install additional dependencies
          pip install \
            extract-dtb \
            pycryptodome \
            protobuf \
            backports.lzma \
            requests \
            tqdm \
            colorama \
            lz4 \
            zstandard \
            git+https://github.com/sebastianmuetzel/dumpyara.git
          echo "::endgroup::"
          
          # Verify installations
          echo "âœ… Python packages installed"
          python3 -c "import dumpyara; print('dumpyara available')" || true
          python3 -c "import aospdtgen; print('aospdtgen available')" || true

      - name: â¬‡ï¸ Download Firmware
        id: download
        run: |
          echo "::group::Downloading firmware from URL..."
          mkdir -p ${{ env.OUTPUT_DIR }}
          
          # Create download directory
          DOWNLOAD_DIR="${{ env.WORKSPACE }}/downloads"
          mkdir -p "$DOWNLOAD_DIR"
          
          # Extract filename from URL or use default
          FILENAME=$(basename "${{ inputs.rom_url }}" | cut -d'?' -f1 | cut -d'#' -f1)
          if [[ -z "$FILENAME" ]] || [[ "$FILENAME" == *"="* ]]; then
            FILENAME="firmware.zip"
          fi
          
          echo "ðŸ“¥ Downloading: $FILENAME"
          echo "ðŸ”— URL: ${{ inputs.rom_url }}"
          
          # Download with aria2c for speed and reliability
          if command -v aria2c &> /dev/null; then
            aria2c -x16 -s16 -j4 -c \
              --file-allocation=none \
              --summary-interval=10 \
              --console-log-level=warn \
              --download-result=hide \
              -d "$DOWNLOAD_DIR" \
              -o "$FILENAME" \
              "${{ inputs.rom_url }}" || \
            curl -L -o "$DOWNLOAD_DIR/$FILENAME" --progress-bar "${{ inputs.rom_url }}"
          else
            curl -L -o "$DOWNLOAD_DIR/$FILENAME" --progress-bar "${{ inputs.rom_url }}"
          fi
          
          # Verify download
          if [[ ! -f "$DOWNLOAD_DIR/$FILENAME" ]]; then
            echo "âŒ Download failed!"
            exit 1
          fi
          
          FILE_SIZE=$(du -h "$DOWNLOAD_DIR/$FILENAME" | cut -f1)
          echo "âœ… Downloaded: $FILENAME ($FILE_SIZE)"
          echo "firmware_path=$DOWNLOAD_DIR/$FILENAME" >> $GITHUB_OUTPUT
          echo "firmware_name=$FILENAME" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ðŸ” Pre-Dump Analysis
        id: analysis
        run: |
          echo "::group::Analyzing firmware archive..."
          FIRMWARE_PATH="${{ steps.download.outputs.firmware_path }}"
          
          # Detect archive type and contents
          echo "ðŸ“¦ Archive contents:"
          if command -v 7z &> /dev/null; then
            7z l "$FIRMWARE_PATH" 2>/dev/null | head -50 || unzip -l "$FIRMWARE_PATH" 2>/dev/null | head -50
          else
            unzip -l "$FIRMWARE_PATH" 2>/dev/null | head -50 || echo "Cannot list archive contents"
          fi
          
          # Check for specific patterns
          if unzip -l "$FIRMWARE_PATH" 2>/dev/null | grep -q "payload.bin"; then
            echo "ðŸ“‹ Detected: A/B OTA (payload.bin)"
            echo "rom_format=ab_ota" >> $GITHUB_OUTPUT
          elif unzip -l "$FIRMWARE_PATH" 2>/dev/null | grep -q "super.img"; then
            echo "ðŸ“‹ Detected: Dynamic partitions (super.img)"
            echo "rom_format=dynamic" >> $GITHUB_OUTPUT
          elif unzip -l "$FIRMWARE_PATH" 2>/dev/null | grep -q ".tar.md5"; then
            echo "ðŸ“‹ Detected: Samsung tar.md5"
            echo "rom_format=tar_md5" >> $GITHUB_OUTPUT
          elif [[ "$FIRMWARE_PATH" == *.kdz ]] || unzip -l "$FIRMWARE_PATH" 2>/dev/null | grep -q ".kdz"; then
            echo "ðŸ“‹ Detected: LG KDZ format"
            echo "rom_format=kdz" >> $GITHUB_OUTPUT
          else
            echo "rom_format=standard" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: ðŸ—‚ï¸ Extract Firmware with Dumpyara
        id: dumpyara
        run: |
          echo "::group::Running dumpyara extraction..."
          FIRMWARE_PATH="${{ steps.download.outputs.firmware_path }}"
          DUMP_DIR="${{ env.OUTPUT_DIR }}/dump"
          
          mkdir -p "$DUMP_DIR"
          
          echo "ðŸš€ Starting dumpyara extraction..."
          echo "   Source: $FIRMWARE_PATH"
          echo "   Output: $DUMP_DIR"
          
          # Run dumpyara with verbose output
          python3 -m dumpyara "$FIRMWARE_PATH" -o "$DUMP_DIR" 2>&1 | tee "${{ env.OUTPUT_DIR }}/dumpyara.log" || {
            echo "âš ï¸ Dumpyara failed with module run, trying direct import..."
            python3 -c "from dumpyara.main import main; import sys; sys.argv = ['dumpyara', '$FIRMWARE_PATH', '-o', '$DUMP_DIR']; main()" 2>&1 | tee -a "${{ env.OUTPUT_DIR }}/dumpyara.log"
          }
          
          # Find the extracted dump directory (dumpyara creates subfolder)
          EXTRACTED_DIR=$(find "$DUMP_DIR" -maxdepth 2 -type d \( -name "system" -o -name "vendor" -o -name "boot" \) | head -1 | xargs dirname 2>/dev/null || echo "$DUMP_DIR")
          
          if [[ ! -d "$EXTRACTED_DIR" ]]; then
            echo "âŒ No valid extraction found!"
            ls -laR "$DUMP_DIR" || true
            exit 1
          fi
          
          # List extracted contents
          echo "ðŸ“ Extracted contents:"
          ls -la "$EXTRACTED_DIR" 2>/dev/null || ls -la "$DUMP_DIR"
          
          # Detect device info from build.prop if available
          if [[ -f "$EXTRACTED_DIR/system/build.prop" ]]; then
            echo "ðŸ” Reading device info from build.prop..."
            cat "$EXTRACTED_DIR/system/build.prop" 2>/dev/null | grep -E "ro.product.(device|brand|manufacturer|model|name)" | head -10 || true
          elif [[ -f "$EXTRACTED_DIR/system/system/build.prop" ]]; then
            echo "ðŸ” Reading device info from system/system/build.prop..."
            cat "$EXTRACTED_DIR/system/system/build.prop" 2>/dev/null | grep -E "ro.product.(device|brand|manufacturer|model|name)" | head -10 || true
          fi
          
          echo "extracted_path=$EXTRACTED_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Extraction complete!"
          echo "::endgroup::"

      - name: ðŸŒ³ Generate AOSP Device Tree
        id: aospdtgen
        run: |
          echo "::group::Generating AOSP device tree..."
          EXTRACTED_PATH="${{ steps.dumpyara.outputs.extracted_path }}"
          DT_DIR="${{ env.OUTPUT_DIR }}/device-tree-aosp"
          
          mkdir -p "$DT_DIR"
          
          echo "ðŸŒ² Running aospdtgen..."
          echo "   Input: $EXTRACTED_PATH"
          echo "   Output: $DT_DIR"
          
          # Run aospdtgen
          python3 -m aospdtgen -o "$DT_DIR" "$EXTRACTED_PATH" 2>&1 | tee "${{ env.OUTPUT_DIR }}/aospdtgen.log" || {
            echo "âš ï¸ aospdtgen failed with module run, trying direct execution..."
            python3 -c "from aospdtgen.proprietary_files import proprietary_files; from aospdtgen.setup import setup; setup('$EXTRACTED_PATH', '$DT_DIR')" 2>&1 | tee -a "${{ env.OUTPUT_DIR }}/aospdtgen.log" || true
          }
          
          # Find generated tree
          GENERATED_TREE=$(find "$DT_DIR" -type f \( -name "Android.bp" -o -name "Android.mk" -o -name "*.mk" \) | head -1 | xargs dirname 2>/dev/null || echo "$DT_DIR")
          
          echo "ðŸ“ Generated AOSP device tree contents:"
          find "$DT_DIR" -type f 2>/dev/null | head -30 || ls -laR "$DT_DIR" 2>/dev/null || echo "Directory listing failed"
          
          # Count files
          FILE_COUNT=$(find "$DT_DIR" -type f 2>/dev/null | wc -l)
          
          # Create metadata
          cat > "${{ env.OUTPUT_DIR }}/aospdtgen-info.txt" << EOF
          AOSP Device Tree Generation Report
          =================================
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Source ROM: ${{ inputs.rom_url }}
          Extraction Path: $EXTRACTED_PATH
          
          Files Generated: $FILE_COUNT
          EOF
          
          echo "aosp_dt_path=$DT_DIR" >> $GITHUB_OUTPUT
          echo "aosp_file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ðŸ”„ Generate TWRP Device Tree (Optional)
        if: inputs.generate_twrp == true
        id: twrpdtgen
        run: |
          echo "::group::Generating TWRP device tree..."
          EXTRACTED_PATH="${{ steps.dumpyara.outputs.extracted_path }}"
          TWRP_DIR="${{ env.OUTPUT_DIR }}/device-tree-twrp"
          
          mkdir -p "$TWRP_DIR"
          
          # Look for recovery.img or boot.img
          RECOVERY_IMG=$(find "$EXTRACTED_PATH" -maxdepth 3 -name "recovery.img" -o -name "recovery.img.lz4" -o -name "recovery.img.gz" | head -1)
          BOOT_IMG=$(find "$EXTRACTED_PATH" -maxdepth 3 -name "boot.img" -o -name "boot.img.lz4" -o -name "boot.img.gz" | head -1)
          
          TARGET_IMG=""
          if [[ -n "$RECOVERY_IMG" ]]; then
            echo "ðŸ©¹ Found recovery image: $RECOVERY_IMG"
            TARGET_IMG="$RECOVERY_IMG"
          elif [[ -n "$BOOT_IMG" ]]; then
            echo "ðŸ‘¢ Using boot image (no recovery found): $BOOT_IMG"
            TARGET_IMG="$BOOT_IMG"
          else
            echo "âš ï¸ No recovery/boot image found for TWRP generation"
            echo "twrp_status=skipped" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          echo "ðŸ”„ Running twrpdtgen on $TARGET_IMG..."
          python3 -m twrpdtgen -o "$TWRP_DIR" "$TARGET_IMG" 2>&1 | tee "${{ env.OUTPUT_DIR }}/twrpdtgen.log" || {
            echo "âš ï¸ twrpdtgen failed with module run, trying alternative method..."
            python3 -c "from twrpdtgen.twrpdtgen import main; main(['-o', '$TWRP_DIR', '$TARGET_IMG'])" 2>&1 | tee -a "${{ env.OUTPUT_DIR }}/twrpdtgen.log" || true
          }
          
          echo "ðŸ“ TWRP device tree contents:"
          find "$TWRP_DIR" -type f 2>/dev/null | head -20 || echo "No TWRP files generated"
          
          TWRP_COUNT=$(find "$TWRP_DIR" -type f 2>/dev/null | wc -l)
          
          echo "twrp_dt_path=$TWRP_DIR" >> $GITHUB_OUTPUT
          echo "twrp_status=completed" >> $GITHUB_OUTPUT
          echo "twrp_file_count=$TWRP_COUNT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ðŸ“Š Post-Processing & Validation
        run: |
          echo "::group::Post-processing and validation..."
          
          # Create comprehensive report
          REPORT_FILE="${{ env.OUTPUT_DIR }}/GENERATION_REPORT.md"
          
          AOSP_COUNT="${{ steps.aospdtgen.outputs.aosp_file_count }}"
          TWRP_COUNT="${{ steps.twrpdtgen.outputs.twrp_file_count }}"
          
          cat > "$REPORT_FILE" << EOF
          # Device Tree Generation Report
          
          ## ðŸ“‹ Job Information
          - **Workflow Run**: ${{ github.run_id }}
          - **Triggered by**: @${{ github.actor }}
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## ðŸ“¥ Input Parameters
          - **ROM URL**: ${{ inputs.rom_url }}
          - **ROM Type**: ${{ inputs.rom_type }}
          - **Device Codename**: ${{ inputs.device_codename || 'Auto-detected' }}
          - **Manufacturer**: ${{ inputs.manufacturer || 'Auto-detected' }}
          - **Generate TWRP**: ${{ inputs.generate_twrp }}
          
          ## ðŸ”§ Extraction Results
          - **Firmware File**: ${{ steps.download.outputs.firmware_name }}
          - **ROM Format**: ${{ steps.analysis.outputs.rom_format }}
          - **Extracted Path**: ${{ steps.dumpyara.outputs.extracted_path }}
          
          ## ðŸŒ³ AOSP Device Tree
          - **Status**: âœ… Generated
          - **Location**: \`${{ steps.aospdtgen.outputs.aosp_dt_path }}\`
          - **Files**: ${AOSP_COUNT:-0}
          
          EOF
          
          if [[ "${{ inputs.generate_twrp }}" == "true" ]]; then
          cat >> "$REPORT_FILE" << EOF
          ## ðŸ”„ TWRP Device Tree
          - **Status**: ${{ steps.twrpdtgen.outputs.twrp_status }}
          - **Location**: \`${{ steps.twrpdtgen.outputs.twrp_dt_path }}\`
          - **Files**: ${TWRP_COUNT:-0}
          
          EOF
          fi
          
          cat >> "$REPORT_FILE" << EOF
          
          ## ðŸ“ Output Structure
          \`\`\`
          $(find ${{ env.OUTPUT_DIR }} -maxdepth 3 -type d 2>/dev/null | sed 's|${{ env.OUTPUT_DIR }}|output|' || echo "output/")
          \`\`\`
          
          ## ðŸ“ Logs Available
          - Dumpyara log: \`dumpyara.log\`
          - AOSP DT Gen log: \`aospdtgen.log\`
          $([[ "${{ inputs.generate_twrp }}" == "true" ]] && echo "- TWRP DT Gen log: \`twrpdtgen.log\`")
          
          ---
          *Generated by Device Tree Generator Pro*
          EOF
          
          echo "ðŸ“„ Report generated: $REPORT_FILE"
          cat "$REPORT_FILE"
          echo "::endgroup::"

      - name: ðŸ“¦ Package Outputs
        run: |
          echo "::group::Packaging outputs..."
          cd ${{ env.OUTPUT_DIR }}
          
          # Create structured archives
          if [[ -d "device-tree-aosp" ]] && [[ "$(ls -A device-tree-aosp 2>/dev/null)" ]]; then
            tar -czf aosp-device-tree.tar.gz device-tree-aosp/
            echo "âœ… Created aosp-device-tree.tar.gz ($(du -h aosp-device-tree.tar.gz | cut -f1))"
          fi
          
          if [[ -d "device-tree-twrp" ]] && [[ "$(ls -A device-tree-twrp 2>/dev/null)" ]]; then
            tar -czf twrp-device-tree.tar.gz device-tree-twrp/
            echo "âœ… Created twrp-device-tree.tar.gz ($(du -h twrp-device-tree.tar.gz | cut -f1))"
          fi
          
          # Create full dump archive (optional, might be large)
          if [[ -d "dump" ]]; then
            echo "ðŸ“¦ Dump directory size: $(du -sh dump/ | cut -f1)"
            # Only archive if under 2GB
            DUMP_SIZE=$(du -sm dump/ | cut -f1)
            if [[ $DUMP_SIZE -lt 2048 ]]; then
              tar -czf firmware-dump.tar.gz dump/
              echo "âœ… Created firmware-dump.tar.gz"
            else
              echo "âš ï¸ Dump too large to archive ($DUMP_SIZE MB), skipping"
            fi
          fi
          
          # List final artifacts
          echo "ðŸ“¦ Final artifacts:"
          ls -lh *.tar.gz *.md *.txt 2>/dev/null || ls -lh || echo "No archives created"
          echo "::endgroup::"

      - name: â˜ï¸ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: device-tree-${{ github.run_id }}
          path: |
            ${{ env.OUTPUT_DIR }}/*.tar.gz
            ${{ env.OUTPUT_DIR }}/*.md
            ${{ env.OUTPUT_DIR }}/*.txt
            ${{ env.OUTPUT_DIR }}/*.log
          retention-days: 30
          compression-level: 6
          if-no-files-found: warn

      - name: ðŸš€ Create Release (Optional)
        if: inputs.upload_artifacts == true && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dt-gen-${{ github.run_number }}-${{ github.run_id }}
          name: "Device Tree Build ${{ github.run_number }}"
          body_path: ${{ env.OUTPUT_DIR }}/GENERATION_REPORT.md
          files: |
            ${{ env.OUTPUT_DIR }}/*.tar.gz
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Job Summary
        if: always()
        run: |
          echo "## ðŸ¤– Device Tree Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¥ Download | ${{ steps.download.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Analysis | ${{ steps.analysis.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—‚ï¸ Extraction | ${{ steps.dumpyara.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ³ AOSP DT Gen | ${{ steps.aospdtgen.outcome }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.generate_twrp }}" == "true" ]]; then
            echo "| ðŸ”„ TWRP DT Gen | ${{ steps.twrpdtgen.outcome }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Downloads" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts uploaded to workflow run" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.upload_artifacts }}" == "true" ]]; then
            echo "Release created as draft" >> $GITHUB_STEP_SUMMARY
          fi
