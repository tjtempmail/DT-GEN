name: AOSP Device Tree Generator

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Direct link to stock ROM ZIP'
        required: true
        type: string
      rom_type:
        description: 'ROM Format'
        required: true
        type: choice
        options:
          - 'auto-detect'
          - 'payload.bin'
          - 'super.img'
          - 'sparse'
          - 'scatter'
        default: 'auto-detect'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 p7zip-full unzip simg2img e2fsprogs mount
          pip install numpy aospdtgen dumpyara

      - name: Download ROM
        id: download
        run: |
          mkdir -p rom_download work
          cd rom_download
          
          # Download with aria2c
          if ! aria2c -x16 -s16 --allow-overwrite=true -o rom.zip "${{ github.event.inputs.rom_url }}"; then
            wget -O rom.zip "${{ github.event.inputs.rom_url }}" || curl -L -o rom.zip "${{ github.event.inputs.rom_url }}"
          fi
          
          # Check size
          SIZE=$(stat -c%s rom.zip)
          echo "Downloaded: $SIZE bytes"
          
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: File too small, likely HTML page"
            head -c 1000 rom.zip
            exit 1
          fi
          
          echo "path=$(pwd)/rom.zip" >> $GITHUB_OUTPUT

      - name: Extract ROM
        id: extract
        run: |
          cd work
          ROM_TYPE="${{ github.event.inputs.rom_type }}"
          
          # Extract zip
          unzip -o "${{ steps.download.outputs.path }}" || 7z x "${{ steps.download.outputs.path }}"
          
          # Auto detect
          if [ "$ROM_TYPE" = "auto-detect" ]; then
            [ -f payload.bin ] && ROM_TYPE="payload"
            ls *.img 2>/dev/null | grep -q super && ROM_TYPE="super"
            ls *scatter* 2>/dev/null | grep -q . && ROM_TYPE="scatter"
            ls system*.img 2>/dev/null | grep -q . && ROM_TYPE="sparse"
          fi
          
          echo "Type: $ROM_TYPE"
          
          # Process based on type
          case "$ROM_TYPE" in
            payload)
              git clone --depth 1 https://github.com/vm03/payload_dumper.git /tmp/pd
              pip install protobuf
              cd /tmp/pd && python3 payload_dumper.py "${{ github.workspace }}/work/payload.bin" --out "${{ github.workspace }}/out"
              ;;
            super)
              for f in *.img; do simg2img "$f" "${f%.img}.raw.img" 2>/dev/null || true; done
              mkdir -p "${{ github.workspace }}/dump"
              for f in *.raw.img; do
                [ -f "$f" ] || continue
                mkdir -p mnt
                sudo mount -o loop,ro "$f" mnt 2>/dev/null && sudo cp -a mnt/. "${{ github.workspace }}/dump/$(basename $f .raw.img)/" && sudo umount mnt
                rmdir mnt 2>/dev/null || true
              done
              ;;
            scatter|sparse)
              for f in system*.img vendor*.img; do
                [ -f "$f" ] || continue
                simg2img "$f" "${f%.img}.raw.img" 2>/dev/null || cp "$f" "${f%.img}.raw.img"
              done
              mkdir -p "${{ github.workspace }}/dump"
              for f in *.raw.img; do
                [ -f "$f" ] || continue
                mkdir -p mnt
                sudo mount -o loop,ro "$f" mnt 2>/dev/null && sudo cp -a mnt/. "${{ github.workspace }}/dump/$(basename $f .raw.img)/" && sudo umount mnt
                rmdir mnt 2>/dev/null || true
              done
              ;;
          esac
          
          # Find dump path
          if [ -d "${{ github.workspace }}/dump/system" ]; then
            echo "path=${{ github.workspace }}/dump" >> $GITHUB_OUTPUT
          elif [ -d "${{ github.workspace }}/out/system" ]; then
            echo "path=${{ github.workspace }}/out" >> $GITHUB_OUTPUT
          else
            echo "ERROR: No system partition found"
            find "${{ github.workspace }}" -type d | head -20
            exit 1
          fi

      - name: Generate device tree
        run: |
          mkdir -p output
          python3 -m aospdtgen -o output "${{ steps.extract.outputs.path }}" || true
          
          # Check if anything was created
          if [ -z "$(ls -A output 2>/dev/null)" ]; then
            echo "ERROR: No device tree generated"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: device-tree
          path: output/*
          retention-days: 30
